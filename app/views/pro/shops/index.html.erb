<% content_for :main_content do %>
    <div class="main-content ">
      <div class="breadcrumbs" id="breadcrumbs">
        <ul class="breadcrumb">
          <%= render 'partials/home' %>
          <li>
            <% if params[:activity_type_id] == "6" || params[:activity_type_id] == "7" || params[:industry_id].to_i == 10001 %>
                <%= link_to "微餐饮", shops_path(industry_id: 10001) %>
            <% else %>
                <%= link_to "微外卖", shops_path(industry_id: 10002) %>
            <% end %>
          </li>
          <li><a href="#">基本信息</a></li>
        </ul>
        <%#= render '/layouts/qrcode' %>
      </div>
      <div class="page-content">
        <div class="row">
          <div class="tabbable">
            <ul class="nav nav-tabs padding-24 tab-size-bigger">
              <li class="<%= "active" unless @activity %>">
                <% if params[:activity_type_id] == "6" || params[:activity_type_id] == "7" || session[:current_industry_id] == 10001 %>
                    <%= link_to "基本信息", shops_path(industry_id: 10001) %>
                <% elsif params[:activity_type_id] == "9" || session[:current_industry_id] == 10002 %>
                    <%= link_to "基本信息", shops_path(industry_id: 10002) %>
                <% end %>
              </li>
              <!-- 固定有的, 下面的是遍历出来的-->
              <% @shop.activities.each do |activity| %>
                  <% if activity.activity_type.book_dinner? && (params[:activity_type_id] == "6" || params[:activity_type_id] == "7" || session[:current_industry_id] == 10001) %>
                      <li class="<%= "active" if params[:activity_type_id] == "6" %> ">
                        <%= link_to "订餐设置", shops_path(activity_type_id: 6) %>
                      </li>
                  <% elsif activity.activity_type.take_out? && (params[:activity_type_id] == "9"  || session[:current_industry_id] == 10002) %>
                      <li class="<%= "active" if params[:activity_type_id] == "9" %> ">
                        <%= link_to "外卖设置", shops_path(activity_type_id: 9) %>
                      </li>
                  <% elsif activity.activity_type.book_table? && (params[:activity_type_id] == "6" || params[:activity_type_id] == "7" || session[:current_industry_id] == 10001)  %>
                      <li class="<%= "active" if params[:activity_type_id] == "7" %> ">
                       <%= link_to "订座设置", shops_path(activity_type_id: 7) %>
                       </li>
                  <% end %>

              <% end %>
            </ul>
            <div class="tab-content no-border padding-24">

          <% unless @activity %>
              <div id="tab-1" class="tab-pane fade active in">
                <div class="row">
                  <div class="col-xs-12 ">
                    <%= form_for @shop, validate: true do |f| %>
                        <%= f.hidden_field :site_id %>
                        <%= f.hidden_field :shop_type %>

                        <div class="form-group">
                          <label>餐厅名称</label>
                          <div class="clearfix">
                            <%= f.text_field :name, class: "col-xs-6" %>
                          </div>
                        </div>

                        <div class="form-group">
                          <%= f.fields_for :site, @shop.site do |s| %>
                            <%= s.fields_for :system_message_settings, @system_message_setting do |sms|%>
                              <%= sms.hidden_field :system_message_module_id %>
                              <label>新订单通知</label>
                              <div class="clearfix">
                                <audio id="material_audio_player" src=""></audio>
                                <label class="margin-right-20">
                                  <%= sms.check_box :is_open, class: 'ace'%><span class="lbl"> 开启 </span>
                                </label>
                                <label>
                                  <%= sms.check_box :is_open_voice, data: {toggle: 'div', target: '#background_music'}, class: 'ace'%><span class="lbl"> 使用提示音 </span>
                                </label>

                                <div class="<%= sms.object.is_open_voice ? '' : 'hide'%>" id="background_music">
                                  <div class="width-100px pull-left margin-right-10">
                                    <div class="file-btn">
                                      <a href="javascript:;" class="btn btn-primary btn-sm">自定义提示音</a>
                                      <%= sms.file_field :voice, value: '上传背景音乐', class: 'pull-left', accept: 'audio/*' %>
                                    </div>
                                  </div>

                                  <i class="icon-volume-up pull-left"></i>
                                  <i class="icon-play pull-left" data-audio-src="<%= sms.object.voice_url.to_s %>"></i>
                                  <% if sms.object.voice.present? %>
                                    <span class="line-height-32 pull-left">
                                      <%= sms.object.voice.file.try(:filename) %>
                                      <%= link_to '移除', remove_voice_system_message_setting_path(sms.object) %>
                                    </span>
                                  <% end %>
                                  <div class="clearfix"></div>
                                </div>
                              </div>
                            <% end %>
                          <% end %>
                        </div>

                        <button type="submit" class="btn btn-primary btn-sm margin-top-20">保存</button>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>

              <%if @activity %>
                      <!-- tab开始 -->
                      <div id="tab-<%= @activity.activity_type.id %>" class="tab-pane fade active in">
                        <div class="row">
                          <!-- 活动表单开始 -->
                          <%= form_for @activity, validate: true, :html => {:class => "form col-xs-12"} do |f| %>
                              <%= render "weixin_preview", wx_title: @activity.name || '标题', wx_summary: @activity.summary || '描述', wx_pic: (@activity.pic_url.blank? ? '/assets/activity_pics/11.jpg' : @activity.pic_url) %>

                              <div class="col-xs-12 col-md-6 col-lg-7">
                                <div class="form-group">
                                  <label class="control-label">回复关键词<span class="required-star">*</span><span class="icon-question-sign" data-rel="popover" data-trigger="hover" data-placement="right" data-content="关键词不能和其他进行中的活动的关键词重复" data-original-title="" title=""> </span></label>
                                  <div class="clearfix">
                                    <%= f.text_field :keyword, class: "col-xs-6" %>
                                  </div>
                                </div>

                                <div class="form-group">
                                  <label class="control-label">微信消息标题<span class="required-star">*</span><span class="icon-question-sign" data-rel="popover" data-trigger="hover" data-placement="right" data-content="发送关键词后返回的微信消息标题，不能超过64个字" data-original-title="" title=""> </span></label>

                                  <div class="clearfix">
                                    <%= f.text_field :name, class: "col-xs-6 js-copy" %>
                                  </div>
                                </div>

                                <div class="form-group">
                                  <label class="control-label">微信消息图<span class="icon-question-sign" data-rel="popover" data-trigger="hover" data-placement="right" data-content="发送关键词后返回的微信消息图片" data-original-title="" title=""></span></label>
                                  <div class="clearfix">
                                    <div data-name="activity[pic_key]" data-img="<%= @activity.pic_url %>" data-key="<%= @activitypic_key || "" %>" class="cieldon-file width-100px" data-type="1" data-div="#img-1" data-height="200"></div>


                                    <small class="help-inline text-warning line-height-30">图片建议尺寸：720像素*400像素</small>
                                  </div>
                                </div>

                                <div class="form-group">
                                  <label class="control-label">微信消息摘要<span class="icon-question-sign" data-rel="popover" data-trigger="hover" data-placement="right" data-content="发送关键词后返回的微信消息摘要" data-original-title="" title=""></span></label>

                                  <div class="clearfix">
                                    <%= f.text_area :summary, rows: 5, maxlength: 255, placeholder: "不能超过255个字", class: "form-control js-copy-des" %>
                                  </div>
                                </div>

                                <div class="form-group">
                                  <input type="submit" class="btn btn-sm btn-primary" value="保存">
                                </div>
                              </div>
                            <% end %><!-- 表单结束-->
                        </div>
                        <!-- row 结束 -->
                      </div>
                      <!-- tab 结束 -->
              <% end %>

            </div>
          </div>
        </div>
      </div>
    </div>
<% end %>


<% content_for :custom_js do %>
<script>
  $(function(){
    $(".js-copy").keyup(function(){
      $("#preview_title").html($(this).val());
    });
    $(".js-copy-des").keyup(function(){
      $("#preview_summary").html($(this).val());
    });

    <% if params[:task].present? && current_user.try(:task1?) %>
      //显示任务完成  0 是第一个任务 1 2 3，
      $(".shadow").show();   // 添加蒙板
      $(".mission_cont").show();
      $(".mission_box2").eq(0).show().find(".mission_box_div").eq(1).show();
    <% end %>

    var audio_tag = $('#material_audio_player');
    var audio = document.getElementById('material_audio_player');

    $('#background_music i.icon-play, i.icon-pause').on("click", function () {
      if(!$(this).attr('data-audio-src')){
        showTip('warning', '还没有音乐，请上传音乐');
        return false;
      }
      if ($(this).hasClass("icon-play")) {
        if ($(this).data('audio-src') != audio_tag.attr('src')) {
          audio_tag.attr('src', $(this).data('audio-src'));
        }
        audio.play();
        $(this).removeClass("icon-play");
        $(this).addClass("icon-pause");
      }
      else {
        audio.pause();
        $(this).removeClass("icon-pause");
        $(this).addClass("icon-play");
      }
    });
    $('#background_music i.icon-volume-up, i.icon-volume-off').on("click", function () {
      if(audio.muted){
        audio.muted = false;
        $(this).removeClass('icon-volume-off');
        $(this).addClass('icon-volume-up');
      }else{
        audio.muted = true;
        $(this).removeClass('icon-volume-up');
        $(this).addClass('icon-volume-off');
      }
    });
    function auto_file_upload(file_input_id, form_id) {
      var upload_file = function() {
        var music_regex = /(\.mp3)|(\.wma)|(\.wav)|(\.amr)/i;
        var filename    = $('#' + file_input_id).val();
        if ( music_regex.test(filename)) {
          $('#' + form_id).submit();
        } else {
          showTip('warning', '文件格式不正确');
        };
      }
      var upload_input = $('#' + file_input_id);
      if(navigator.userAgent.match(/msie/i)) {
        upload_input.click(function(event) {
          setTimeout(function() {
            if(upload_input.val().length > 0) {
              upload_file();
            }
          }, 0);
        });
      } else {
        upload_input.change(upload_file);
      }
    }

    if ($('#activity_website_attributes_website_setting_attributes_bg_music').length > 0) {
        auto_file_upload('activity_website_attributes_website_setting_attributes_bg_music', 'edit_website_activity');
    };
   });
</script>
<% end %>
