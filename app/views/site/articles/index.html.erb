<% content_for :main_content do %>
<div class="main-content ">
  <div class="breadcrumbs" id="breadcrumbs">
    <ul class="breadcrumb">
      <%= render 'partials/home' %>
      <li><%= link_to '内容管理', 'javascript:;' %></li>
      <% if action_name == 'case' %>
        <li><%= link_to '展示管理', case_site_articles_path %></li>
      <% else %>
        <li><%= link_to '资讯管理', site_articles_path %></li>
      <% end %>
    </ul>
    <%#= render '/layouts/qrcode' %>
  </div>

  <div class="page-content">
    <div class="tabbable">
      <%= render "site/categories/top_categories" %>

      <div class="row margin-top-20">
        <%= form_for @search, url: action_name == 'case' ? case_site_articles_path : site_articles_path, :html => { :method => :get } do |f| %>
          <div class="col-sm-12">
            <div class="col-md-2 row">
              <div class="input-group input-group-text">
                <%= f.text_field :name_like, placeholder: '标题', class: 'col-xs-12' %>
              </div>
            </div>

            <div class="col-md-2">
              <% if action_name == "case" %>
                <%= f.select :site_category_id_eq, @current_site.site_categories.case.pluck(:name, :id), {include_blank: '分类'}, class: 'col-xs-12' %>
              <% else %>
                <%= f.select :site_category_id_eq, @current_site.site_categories.news.pluck(:name, :id), {include_blank: '分类'}, class: 'col-xs-12' %>
              <% end %>

            </div>

            <div class="col-md-2">
              <%= f.select :status_eq, SiteArticle.status_options[0...-1], {include_blank: '状态'}, class: 'col-xs-12' %>
            </div>

            <div class="col-md-2">
              <%= f.select :is_recommend_eq, SiteArticle.is_recommend_options, {include_blank: '推荐'}, class: 'col-xs-12' %>
            </div>

            <div class="col-md-2">
              <button class="btn btn-primary btn-sm btn-filter">查询</button>
            </div>
          </div>
        <% end %>

        <%#= form_tag('', id: 'sss',method: :post) do %>
          <div class="col-md-12 margin-top-20">
            <div class="col-md-7 row">
              <div class="col-md-2 row">
                <%= link_to '新增', action_name == 'case' ? new_site_article_path(type: 2) : new_site_article_path, class: 'btn btn-sm btn-primary btn-filter pull-left' %>
              </div>

              <div class="col-md-2 row">
                <%= button_to '发布', onshelf_all_site_articles_path, class: 'btn btn-primary btn-sm', method: :get, id: :onshelf_all_btn, confirm: '将同时发布选中记录，确定要操作吗？' %>
              </div>
              <div class="col-md-2 row">
                <%= button_to '下线', offshelf_all_site_articles_path, class: 'btn btn-primary btn-sm', method: :get, id: :offshelf_all_btn, confirm: '将同时下线选中记录，确定要操作吗？' %>
              </div>

              <div class="col-md-2 row">
                <%= button_to '推荐到首页', recommend_all_site_articles_path, class: 'btn btn-primary btn-sm', method: :get, id: :recommend_all_btn, confirm: '将推荐选中记录到小程序首页，确定要操作吗？' %>
              </div>
              <div class="col-md-2 row" style="margin-left: 20px; margin-right: 10px;">
                <%= button_to '取消推荐', not_recommend_all_site_articles_path, class: 'btn btn-primary btn-sm', method: :get, id: :not_recommend_all_btn, confirm: '将取消推荐选中记录到小程序首页，确定要操作吗？' %>
              </div>
              <div class="col-md-2 row">
                <%= button_to '删除', delete_all_site_articles_path, class: 'btn btn-primary btn-sm', method: :get, id: :delete_all_btn, confirm: '将同时删除选中的记录，确定要操作吗？' %>
              </div>
            </div>
          </div>

          <div class="col-md-12 margin-top-10">
            <table id="goodsTable" class="table table-striped table-bordered table-hover dataTable ">
              <thead>
                <tr>
                  <th><input type="checkbox" id="all" class='checkbox toggle' style="display:inline;"/></th>
                  <th>分类</th>
                  <th width="210">标题</th>
                  <th>摘要</th>
                  <!-- <th>类型</th> -->
                  <th><%= sort_link @search, :status, '状态' %></th>
                  <th><%= sort_link @search, :is_recommend, '推荐' %></th>
                  <th><%= sort_link @search, :position, '排序' %></th>
                  <th><%= sort_link @search, :created_at, '创建时间' %></th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="colleges_body">
                <% @articles.each do |article| %>
                  <tr data-id="<%= article.id %>">
                    <td><input type="checkbox" class='checkbox' name="site_article_ids[]" value="<%= article.id %>" style="display:inline;"/></td>
                    <td><%= article.site_category.name %></td>
                    <td><%= article.name %></td>
                    <td><%= article.summary %></td>
                    <!-- <td><%= article.article_type_name %></td> -->
                    <td><%= article.status_name %></td>
                    <td><%= article.is_recommend_name %></td>
                    <td><input type="text" class="position" value="<%= article.position %>" size="5"></td>
                    <td><%= article.created_at %></td>
                    <td class="txt-left-align">
                      <%= link_to '编辑', edit_site_article_path(article) %>
                      <%= link_to '删除',site_article_path(article), method: :delete, data: {confirm:"确定删除?"} %>
                      <%= link_to '复制链接', 'javascript:;', onclick: "copylink(this);", data: { link: article.news? ? "/pages/site/article?id=#{article.id}&name=#{article.name}" : "/pages/site/case_show?id=#{article.id}&name=#{article.name}" } %>
                    </td>
                  </tr>
                <% end %>
                <% if @articles.blank? %>
                  <tr><td colspan="12">无记录</td></tr>
                <% end %>
              </tbody>
            </table>
            <%= paginate @articles %>
          </div>
        <%# end %>
      </div>
    </div>

  </div>
</div>
<% end %>

<% content_for :custom_js do %>

<script type="text/javascript">
$("#onshelf_all_btn").on("click", function(e){
  if( $('#colleges_body input:checkbox:checked').length == 0 ) {
    alert('请先选择记录');
    return false;
  }

  var url_base = '<%= onshelf_all_site_articles_path %>?';
  var suffix = [].join.call($('#colleges_body input:checkbox:checked').map(function(index, el) {
    return "ids[]=" + $(el).val();
  }), "&");
  $('#onshelf_all_btn').attr('href', url_base + suffix);
});

$("#offshelf_all_btn").on("click",function(e){
  if( $('#colleges_body input:checkbox:checked').length == 0 ) {
    alert('请先选择记录');
    return false;
  }

  var url_base = '<%= offshelf_all_site_articles_path %>?';
  var suffix = [].join.call($('#colleges_body input:checkbox:checked').map(function(index, el) {
    return "ids[]=" + $(el).val();
  }), "&");
  $('#offshelf_all_btn').attr('href', url_base + suffix);
});

$("#recommend_all_btn").on("click",function(e){
  if( $('#colleges_body input:checkbox:checked').length == 0 ) {
    alert('请先选择记录');
    return false;
  }

  var url_base = '<%= recommend_all_site_articles_path %>?';
  var suffix = [].join.call($('#colleges_body input:checkbox:checked').map(function(index, el) {
    return "ids[]=" + $(el).val();
  }), "&");
  $('#recommend_all_btn').attr('href', url_base + suffix);
});

$("#not_recommend_all_btn").on("click",function(e){
  if( $('#colleges_body input:checkbox:checked').length == 0 ) {
    alert('请先选择记录');
    return false;
  }

  var url_base = '<%= not_recommend_all_site_articles_path %>?';
  var suffix = [].join.call($('#colleges_body input:checkbox:checked').map(function(index, el) {
    return "ids[]=" + $(el).val();
  }), "&");
  $('#not_recommend_all_btn').attr('href', url_base + suffix);
});

$("#delete_all_btn").on("click",function(e){
  if( $('#colleges_body input:checkbox:checked').length == 0 ) {
    alert('请先选择记录');
    return false;
  }

  var url_base = '<%= delete_all_site_articles_path %>?';
  var suffix = [].join.call($('#colleges_body input:checkbox:checked').map(function(index, el) {
    return "ids[]=" + $(el).val();
  }), "&");
  $('#delete_all_btn').attr('href', url_base + suffix);
})


$(function(){
  $("#all").click(function(){
    $("input[name = 'site_article_ids[]']").each(function (i, checkbox) {
      checkbox.checked = true;
    });
    $("input[name = 'site_article_ids[]']").attr("checked",this.checked);
    var $subBox = $("input[name = 'site_article_ids[]']");
    $subBox.click(function(){
       $("#all").attr("checked",$subBox.length == $("[name = 'site_article_ids[]']:checked").length ? true : false);
   });
  });

});

function copylink(e) {
  console.log($(e).data('link'));
  var $temp = $("<input>");
  $("body").append($temp);
  $temp.val($(e).data('link')).select();
  document.execCommand("copy");
  $temp.remove();
  showTip("success","链接复制成功");
}

$('input.position').blur(function(){
  var id = $(this).closest('tr').attr('data-id');
  $.post("/site/articles/"+id+"/update_sort?position=" + $(this).val());
});
</script>

<% end %>
