<div class="html order_detial order_new" id="J_html">
    <!-- 有默认地址渲染第一片段  没有渲染第二片段 -->
    <% if @shop.present? %>
        <a href="javascript:;" class="paytype" id="J_paytype" data-type="2" data-aid="<%= @shop.id %>" data-shopname="<%= @shop.name %>" data-day="<%= EcDiningTime.first_dining_date.strftime("%Y-%m-%d") %>" data-timepart="<%= EcDiningTime.first_of_today.try(:id) %>" data-phone="<%= @user.mobile %>" data-name="<%= @user.name %>" data-sheng="<%= @shop.province_id %>" data-shi="<%= @shop.city_id %>" data-qu="<%= @shop.district_id %>" data-street="<%= @shop.address %>" data-address="<%= @shop.address_display %>">
            <p class="pt_til"><span class="pt_ado">配送方式</span><span class="pt_way pt_way_active" id="J_pt_way">配送到餐厅酒柜</span></p>
            <p class="pt_sn"><%= @shop.name %></p>
            <p class="pt_text pt_texta"><%= EcDiningTime.first_dining_date.strftime("%m-%d") %>(<%= display_wday(EcDiningTime.first_dining_date) %>)  <%= EcDiningTime.first_of_today.try(:start_at).try(:strftime, "%H:%M") %>- <%= EcDiningTime.first_of_today.try(:end_at).try(:strftime, "%H:%M") %>  就餐</p>
            <p class="pt_text pt_textb"><%= @user.mobile %>  <%= @user.name %></p>
            <p class="pt_adr"><%= @shop.address_display %></p>
        </a>
    <% elsif @default_address.present? %>
        <a href="javascript:;" class="paytype" id="J_paytype" data-type="1" data-aid="<%= @default_address.id %>" data-shopname="" data-day="" data-timepart="" data-phone="<%= @default_address.mobile %>" data-name="<%= @default_address.username %>" data-sheng="<%= @default_address.province_id %>" data-shi="<%= @default_address.city_id %>" data-qu="<%= @default_address.district_id %>" data-street="<%= @default_address.address %>" data-address="<%= @default_address.address_display %>">
            <p class="pt_til"><span class="pt_ado">配送方式</span><span class="pt_way pt_way_active" id="J_pt_way">配送到家</span></p>
            <p class="pt_text pt_textb"><%= @default_address.mobile %>  <%= @default_address.username %></p>
            <p class="pt_adr"><%= @default_address.address_display %></p>
        </a>
    <% else %>

        <!-- <a href="javascript:;" class="paytype" id="J_paytype" data-type="2" data-aid="2" data-shopname="深山老屋(广兰路店)" data-day="2017/04/29" data-timepart="5" data-phone="18149776147" data-name="张小华" data-sheng="2" data-shi="1" data-qu="1" data-street="浦东软件园郭守敬园1号楼525室" data-address="上海市浦东新区浦东软件园郭守敬园1号楼1上海市浦东新区浦东软件园郭守敬园1号楼525室">
            <p class="pt_til"><span class="pt_ado">配送方式</span><span class="pt_way pt_way_active" id="J_pt_way">配送到餐厅酒柜</span></p>
            <p class="pt_sn">深山老屋(广兰路店)</p>
            <p class="pt_text pt_texta">04-16(星期日)  13:00-14:00  就餐</p>
            <p class="pt_text pt_textb">18149776147  张小华</p>
            <p class="pt_adr">上海市浦东新区浦东软件园郭守敬园1号楼1上海市浦东新区浦东软件园郭守敬园1号楼525室</p>
        </a> -->
        <a href="javascript:;" class="paytype" id="J_paytype">
            <p class="pt_til"><span class="pt_ado">配送方式</span><span class="pt_way" id="J_pt_way">配送到家或餐厅酒柜</span></p>
        </a>

    <% end %>

    <div class="plist" id="J_plist"></div>
    <div class="formline">
        <div class="fline">
            <span class="ado">用户自提</span>
            <div class="text_line">&ensp;<a href="javascript:;" class="switch" id="J_self_pickup_switch"></a></div>
        </div>
        <div class="fline">
            <span class="ado">快递费用</span>
            <div class="text_line">￥0.00</div>
        </div>
        <div class="fline">
            <span class="ado">开具发票</span>
            <div class="text_line">&ensp;<a href="javascript:;" class="switch" id="J_switch"></a></div>
        </div>
        <div class="J_fapiao fline">
            <span class="ado">发票类型</span>
            <div class="input_select">
                <select class="ctrol ctrol_select" id="J_fapiaotype">
                    <option value="1" selected="selected">个人发票</option>
                    <option value="2">公司发票</option>
                </select></div>
        </div>
        <div class="J_fapiao fline">
            <span class="ado">发票抬头</span>
            <div class="input_line"><input type="text" name="" class="ctrol" placeholder="请填写发票抬头" id="J_fapiaotil"></div>
        </div>
    </div>

    <p class="liuy"><input type="text" class="liuy_ctrol" id="J_liuyan" placeholder="给商家留言"></p>

    <div class="pinfo">
        <div class="plines">
            <p class="pline"><span class="pline_ado">商品金额</span><span>￥<span class="J_countprice"></span></span></p>
            <p class="pline"><span class="pline_ado">运费</span>￥<span id="J_freight">0.00</span></p>
        </div>
    </div>
    
    <div class="botline">
        <span class="bl_l">实付款：<span class="i_pricb">￥</span><span class="J_countprice countprice" id="J_total"></span></span>
        <a href="javascript:;" class="bl_btn" id="J_sentorder">提交订单</a>
    </div>

</div>

<div class="pop" id="J_pop_all">
    <a href="javascript:;" class="J_close_pop close_pop" data-target="#J_pop_all"></a>
    <!-- 地址类型选择 start -->
    <div class="J_pop_slide pop_slide pop_adtype" id="J_pop_adtype">
        <p class="ptil">选择配送方式<a href="javascript:;" class="J_close_pop pclose" data-target="#J_pop_all"></a></p>
        <div class="pop_adts">
            <a href="javascript:;" class="J_pop_adt pop_adt" data-type="1">
                <img src="/wap/assets/images/type01b.png" class="pop_adt_ico">
                <p class="pop_adt_name">配送到家</p>
            </a>
            <a href="javascript:;" class="J_pop_adt pop_adt" data-type="2">
                <img src="/wap/assets/images/type01a.png" class="pop_adt_ico">
                <p class="pop_adt_name">配送到餐厅酒柜</p>
            </a>
        </div>
    </div>
    <!-- end -->
    <!-- 地址类型选择 start 需后端渲染-->
    <div class="J_pop_slide pop_slide pop_house" id="J_pop_house">
        <p class="ptil">收货地址<a href="javascript:;" class="J_close_pop pclose" data-target="#J_pop_all"></a> <a href="javascript:;" class="J_pop_back pback" data-from="#J_pop_house" data-to="#J_pop_adtype"></a></p>
        <div class="pop_hous" id="J_pop_hous">
            <% if @user.ec_addresses.blank? %>
                <div class="pop_empty">
                    <img src="/wap/assets/images/adr_em.png" class="eimg">
                    <p class="etext">暂无收货地址</p>
                </div>
            <% else %>
                <% @user.ec_addresses.each do |address| %>
                    <div class="pop_hou">
                        <a href="javascript:;" class="J_adr_edit adr_edit" data-aid="<%= address.id %>" data-name="<%= address.username %>" data-phone="<%= address.mobile %>" data-sheng="<%= address.province_id %>" data-shi="<%= address.city_id %>" data-qu="<%= address.district_id %>" data-street="<%= address.address %>" data-address="<%= address.address_display %>"></a>
                        <a href="javascript:;" class="J_adr_select adr_select " data-aid="<%= address.id %>" data-name="<%= address.username %>" data-phone="<%= address.mobile %>" data-sheng="<%= address.province_id %>" data-shi="<%= address.city_id %>" data-qu="<%= address.district_id %>" data-street="<%= address.address %>" data-address="<%= address.address_display %>">
                            <p class="pop_hou_t"><%= address.username %>&ensp;&ensp;<%= address.mobile %></p>
                            <p class="pop_hou_b"><%= address.address_display %></p>
                        </a>
                    </div>
                <% end %>
            <% end %>
        </div>
        <p class="J_pop_bot pop_bot"><a href="javascript:;" id="J_hos_new" class="pop_bot_btn">+新增收货地址</a></p>
    </div>
    <!-- end -->
    <!-- 新建家庭地址 start -->
    <div class="J_pop_slide pop_slide pop_hounew" id="J_pop_hounew">
        <p class="ptil">收货地址<a href="javascript:;" class="J_close_pop pclose" data-target="#J_pop_all"></a><a href="javascript:;" class="J_pop_back pback" data-from="#J_pop_hounew" data-to="#J_pop_house"></a></p>
        <div class="pop_hnews">
            <div class="formline">
                <div class="fline">
                    <div class="input_line"><input type="text" name="" class="ctrol" placeholder="请填写收货人姓名" id="J_name_h"></div>
                </div>
                <div class="fline">
                    <div class="input_line"><input type="text" name="" class="ctrol" placeholder="请填写收货电话" id="J_phone_h"></div>
                </div>
                <div class="fline">
                    <div class="input_select">
                        <select class="ctrol ctrol_select" id="J_sheng">
                            <option value="0">选择省</option>
                            <% Province.pluck(:id, :name).each do |province| %>
                                <option value="<%= province[0] %>"><%= province[1] %></option>
                            <% end %>
                        </select>
                        <select class="ctrol ctrol_select" id="J_shi">
                            <option value="0">选择市</option>
                            <!-- <option value="1">上海市</option> -->
                        </select>
                        <select class="ctrol ctrol_select" id="J_qu">
                            <option value="0">选择区</option>
                            <!-- <option value="1">浦东新区</option>
                            <option value="2">长宁区</option> -->
                        </select>
                    </div>
                </div>
                <div class="fline">
                    <div class="input_line"><input type="text" name="" class="ctrol" placeholder="请填写详细地址，不少于5个字" id="J_detial"></div>
                </div>
            </div>
        </div>
        <p class="J_pop_bot pop_bot"><a href="javascript:;" id="J_hounew_save" class="pop_bot_btn">保存</a></p>
    </div>
    <!-- end -->
    <!-- 配送到餐厅酒柜 start 需后端渲染餐厅地址-->
    <div class="J_pop_slide pop_slide pop_canting pop_adr" id="J_pop_canting" style="height:100%;">
        <p class="ptil">配送到餐厅酒柜<a href="javascript:;" class="J_close_pop pclose" data-target="#J_pop_all"></a><a href="javascript:;" class="J_pop_back pback" data-from="#J_pop_canting" data-to="#J_pop_adtype"></a></p>
        <div class="pmaxheight pl10">
            <div class="J_pop_line pop_line pop_line_right" data-target="#J_pop_chosesp"><span class="pop_ado">就餐门店</span><p class="pop_ltext" id="J_can_name">选择配送餐厅</p></div>
            <div class="J_pop_line pop_line pop_line_right" data-target="#J_pop_chosetime"><span class="pop_ado">就餐时间</span><p class="pop_ltext"><span id="J_pday_in"></span>&ensp;&ensp;<span id="J_ptime_in"></span></p></div>
            <div class="pop_line"><span class="pop_ado">就餐人姓名</span><p class="pop_ctrol"><input type="text" name="" id="J_name" class="J_focus ctrol" placeholder="请填写就餐人姓名" value="<%= @user.name %>"></p></div>
            <div class="pop_line"><span class="pop_ado">就餐人电话</span><p class="pop_ctrol"><input type="tel" name="" id="J_phone" class="J_focus ctrol" placeholder="请填写就餐人手机号" value="<%= @user.mobile %>"></p></div>
        </div>

        <p class="J_pop_bot pop_bot"><a href="javascript:;" id="J_saveadr" class="pop_bot_btn">确定</a></p>
    </div>
    <!-- end -->
    <!-- 支付类型 start -->
    <div class="J_pop_slide pop_slide pop_pay pop_paya" id="J_pop_pay">
        <a href="javascript:;" class="way" id="J_pay_wx" data-onumber="23423423423"><img src="/wap/assets/images/pay01.png" class="waym"><p class="waytil">微信支付</p><p class="waytp">微信安全支付</p></a>
        <a href="javascript:;" class="way" id="J_zhifubao"><img src="/wap/assets/images/pay02.png" class="waym"><p class="waytil">支付宝支付</p><p class="waytp">方便、快捷、安全</p></a>
    </div>
    <!-- end -->
</div>

<div class="pop" id="J_pop_all_part" style="z-index: 10;">
    <!-- 选择就餐门店 start -->
    <div class="J_pop_slide pop_slide pop_adr" id="J_pop_chosesp">
        <p class="ptil">选择就餐门店<a href="javascript:;" class="J_close_pop_part pclose" data-target="#J_pop_all_part"></a></p>
        <div class="psubbox_bot">
            <% EcShop.pass.each do |shop| %>
                <a href="javascript:;" data-aid="<%= shop.id %>" data-shopname="<%= shop.name %>" data-address="<%= shop.address_display %>" class="J_padr padr">
                    <p class="padr_name"><%= shop.name %></p>
                    <p class="padr_map"><%= shop.address_display %></p>
                </a>
            <% end %>
        </div>
    </div>
    <!-- end -->
    <!-- 选择就餐时间 start -->
    <div class="J_pop_slide pop_slide pop_adr" id="J_pop_chosetime">
        <p class="ptil">选择就餐时间<a href="javascript:;" class="J_close_pop_part pclose" data-target="#J_pop_all_part"></a></p>
        <div class="psubbox_bot ovh">
            <div class="pstime" id="J_pday"></div><div class="pstime" id="J_ppart"></div>
        </div>
    </div>
    <!-- end -->
    
</div>

<script type="text/javascript">
    // ！！！！！！！！！订单提交后做总价对比，方式恶意篡改本地localStorage！！！！！！！！！！！！
    $(function(){
        // data 是最后提交订单所需要的对象@！！！！！！！！！！！！！！！
        var data = JSON.parse(localStorage.statement);//, // 获取商品信息！！！！！！！！！
            J_plist = $('#J_plist'),
            J_switch = $("#J_switch"),
            J_self_pickup_switch = $("#J_self_pickup_switch"),
            J_fapiao = $('.J_fapiao'),
            J_fapiaotype = $('#J_fapiaotype'),
            J_fapiaotil = $('#J_fapiaotil'),
            J_sentorder = $('#J_sentorder'),
            J_pop_pay = $('#J_pop_pay');

        var isajax = false; //设置开关 防止重复提交

        data.lstype = 0; //临时存储
        data.fapiao = {"isget":0,"type":1,"title":""}; //发票默认不开具，默认类型为个人id，抬头为空，渲染时根据需要更改具体定义方式！！！！！！
        data.self_pickup = {"isget":0}
        data.luggage = 20; // 设置运费！！！！！！！！！！
        data.address = {"type":null,"info":{}}; // 收货地址对象！！！！！！！！！！

        var str = '',list = data.list,plen = list.length;
        for(var i=0;i<plen;i++){
            var v = list[i],
                pnor = v.pnor?'<p class="i_pnor">规格：'+v.pnor+'</p>':'',
                zeng = v.zeng?'<p class="i_zeng">'+v.zengtext+'</p>':'';
            str+='<a href="/wap/items/'+v.tid+'" class="i_proc">\
                <img src="'+v.pimg+'" class="i_pimg">\
                <p class="i_pname">'+v.name+'</p>'+pnor+zeng+'\
                <p class="i_prica"><span class="i_pricb">￥</span>'+parseFloat(v.price).toFixed(2)+'<span class="i_pnum">x'+v.num+'</span></p>\
            </a>';
        };
        J_plist.html(str);

        J_switch.click(function(){
            var self = $(this);
            if(self.hasClass('switch_active')){
                self.removeClass('switch_active');
                data.fapiao.isget = 0;
                J_fapiao.hide();
            }else{
                self.addClass('switch_active');
                data.fapiao.isget = 1;
                J_fapiao.show();
            }
        });

        J_self_pickup_switch.click(function(){
            var self = $(this);
            if(self.hasClass('switch_active')){
                self.removeClass('switch_active');
                data.self_pickup.isget = 0;
                calc_freight(); //重新计算运费
            }else{
                self.addClass('switch_active');
                data.self_pickup.isget = 1;
                // 不计运费
                $('#J_freight').html('0.00');
                $('#J_total').html((parseFloat(data.countprice)).toFixed(2));
            }
        });

        $('.J_countprice').html(parseFloat(data.countprice).toFixed(2));

        // 提交订单事件
        J_sentorder.click(function(){
            data.fapiao.title = J_fapiaotil.val();
            console.log(data)

            if(!data.address.type || !data.address.info.aid){
                CUES.tip({"msg":"请选择配送方式","type":"danger"});
                return false;
            };

            if ( data.self_pickup.isget == 0 ) {
                if(!data.address.info.name){
                    CUES.tip({"msg":"收货人姓名为空","type":"danger"});
                    return false;
                };
                if(!data.address.info.phone){
                    CUES.tip({"msg":"收货人电话为空","type":"danger"});
                    return false;
                };
            }

            isajax = true;
            // ajax生成订单
            $.ajax({ 
                type: "POST",
                // url: "/api/shi.json?v="+(new Date().getTime()),
                url: "/wap/orders",
                data: {data},
                dataType: "json",
                success: function(res){
                    isajax = false;
                    if(res.code){
                        // $('#J_zhifubao').attr('href','zhifubao.html?ordernumber=2132352345234'); // 设置支付宝外部链接
                        // window.location.href = "/payment/wxpay/pay?site_id="+res.data.site_id+"&out_trade_no="+res.data.out_trade_no+"&openid="+res.data.openid;

                        window.location.href = "/wap/orders/"+res.data.order_id

                        // 微信支付的一些操作可以放在这
                    } else {
                        CUES.tip({"msg":res.msg,"type":"danger"});
                        return false;
                    }
                }
            });
            // J_pop_all.show();
            // setTimeout(function(){
            //     J_pop_all.addClass('pop_active');
            //     J_pop_pay.addClass('pop_slide_active');
            // },10)
        });

         // 微信支付
        $('#J_pay_wx').click(function(){
            alert('微信支付接口');
            // 支付完成后调用以下代码 start
            window.location.href = "order_detial.html?ordernumber=2132352345234";
            //end
        });

        var J_paytype = $("#J_paytype"),
            J_sheng = $('#J_sheng'),
            J_shi = $("#J_shi"),
            J_qu = $("#J_qu"),
            J_pop_slide = $('.J_pop_slide'),
            J_html = $('#J_html'),
            J_pop_all = $('#J_pop_all'),
            J_pop_adtype = $('#J_pop_adtype'),
            J_pop_house = $('#J_pop_house'),
            J_pop_canting = $('#J_pop_canting'),
            J_pop_hous = $('#J_pop_hous'),
            J_pop_hounew = $('#J_pop_hounew'),
            J_hounew_save = $("#J_hounew_save");


        var obj_info = {},adr_edit = 0;
        if(J_paytype.attr('data-type')){
            data.address.type = J_paytype.attr('data-type');
            obj_info.aid = parseInt(J_paytype.attr('data-aid'));
            obj_info.name = J_paytype.attr('data-name');
            obj_info.phone = J_paytype.attr('data-phone');
            obj_info.sheng = parseInt(J_paytype.attr('data-sheng'));
            obj_info.shi = parseInt(J_paytype.attr('data-shi'));
            obj_info.qu = parseInt(J_paytype.attr('data-qu'));
            obj_info.street = J_paytype.attr('data-street');
            obj_info.address = J_paytype.attr('data-address');
            if(obj_info.aid=="2"){ //判断是否是配送至餐厅
                obj_info.shopname = J_paytype.attr('data-shopname');
                obj_info.day = J_paytype.attr('data-day');
                obj_info.timepart = J_paytype.attr('data-timepart');
            }
            data.address.info = obj_info;
        };

        J_paytype.click(function(){
            J_pop_all.show();
            setTimeout(function(){
                J_pop_all.addClass('pop_active');
                J_pop_adtype.addClass('pop_slide_active');
            },10)
        });

        // 选择配送方式
        $('.J_pop_adt').click(function(){
            var v = $(this).attr('data-type');
            data.lstype = v;
            if(v=='1'){
                show_pop_slide(J_pop_adtype,J_pop_house);
            }else{
                show_pop_slide(J_pop_adtype,J_pop_canting);
                setTimeout(function(){
                    console.log(456)
                    J_html.hide();
                    J_pop_all.addClass('pop_h100');
                },1000);
            }
        });

        // 切换弹出框
        function show_pop_slide(self,target){
            self.removeClass('pop_slide_active');
            setTimeout(function(){
                target.addClass('pop_slide_active');
            },200)
        };

        // 选择配送到家地址
        J_pop_hous.on('click','.J_adr_select',function(){
            var self = $(this),obj = {};
            obj.aid = parseInt(self.attr('data-aid'));
            obj.name = self.attr('data-name');
            obj.phone = self.attr('data-phone');
            obj.sheng = parseInt(self.attr('data-sheng'));
            obj.shi = parseInt(self.attr('data-shi'));
            obj.qu = parseInt(self.attr('data-qu'));
            obj.street = self.attr('data-street');
            obj.address = self.attr('data-address');

            data.address.info = obj;
            data.address.type = data.lstype;
            setadrdom();
            close_pop();
            calc_freight();
        }).on('click','.J_adr_edit',function(){
            var self = $(this),obj = {};
            obj.aid = parseInt(self.attr('data-aid'));
            obj.name = self.attr('data-name');
            obj.phone = self.attr('data-phone');
            obj.sheng = parseInt(self.attr('data-sheng'));
            obj.shi = parseInt(self.attr('data-shi'));
            obj.qu = parseInt(self.attr('data-qu'));
            obj.street = self.attr('data-street');
            obj.address = self.attr('data-address');

            $('#J_name_h').val(obj.name);
            $('#J_phone_h').val(obj.phone);
            $('#J_detial').val(obj.street);

            J_sheng.val(obj.sheng);
            J_shi.val(obj.shi);
            J_qu.val(obj.qu);

            adr_edit = obj.aid;

            J_sheng.change(); // 渲染市区联动

            show_pop_slide(J_pop_house,J_pop_hounew);

        })

        // 渲染
        function setadrdom(){
            var v = data.address,info = v.info,
                cstr = v.type=='1'?'':'<p class="pt_sn">'+info.shopname+'</p><p class="pt_text pt_texta">'+info.day_name+'&ensp;&ensp;&ensp;'+info.timepart_name+'&ensp;&ensp;就餐</p>';
            var str = '<p class="pt_til"><span class="pt_ado">配送方式</span><span class="pt_way pt_way_active">'+(v.type=="1"?'配送到家':'配送到餐厅酒柜')+'</span></p>'+cstr+'<p class="pt_text pt_textb">'+info.phone+'&ensp;&ensp;'+info.name+'</p><p class="pt_adr">'+info.address+'</p>';

            J_paytype.html(str);
        }

        $('.J_close_pop').click(function(){
            // $($(this).attr('data-target')).removeClass('pop_active').hide();
            $($(this).attr('data-target')).removeClass('pop_active pop_h100').hide();
            J_html.show();
            J_pop_slide.removeClass('pop_slide_active');
        });

        function close_pop(){
            J_pop_slide.removeClass('pop_slide_active');
            J_pop_all.removeClass('pop_active').hide();
        };

        $('.J_pop_back').click(function(){
            var self = $(this);
            if(self.attr('data-from')=="#J_pop_canting"){
                J_pop_all.removeClass('pop_h100');
                J_html.show();
            };
            show_pop_slide($(self.attr('data-from')),$(self.attr('data-to')));
        });

        $('#J_hos_new').click(function(){
            show_pop_slide(J_pop_house,J_pop_hounew);
        });

        // 省市区联动
        J_sheng.change(function(){
            var vid = $(this).val();
            console.log(vid)
            if(vid==0){// 表示未选择
                J_shi.html('<option value="0">选择市</option>');
            }else{
                isajax = true;
                // ajax请求市内容
                $.ajax({ 
                    type: "GET",
                    url: "/wap/cities",
                    data: {province_id: vid},
                    dataType: "json",
                    success: function(res){
                        isajax = false;
                        if(res.code){
                            var dt = res.data,len = dt.length,str = '';
                            for(var i=0;i<len;i++){
                                var v = dt[i];
                                str+='<option value="'+v.id+'">'+v.name+'</option>';
                            };
                            J_shi.html('<option value="0">选择市</option>'+str);
                            J_qu.html('<option value="0">选择区</option>');
                        }
                    }
                });
            }
        });



        J_shi.change(function(){
            var vid = $(this).val();
            if(vid==0){// 表示未选择
                J_qu.html('<option value="0">选择区</option>');
            }else{
                isajax = true;
                // ajax请求市内容
                $.ajax({ 
                    type: "GET",
                    url: "/wap/districts",
                    data: {city_id: vid},
                    dataType: "json",
                    success: function(res){
                        isajax = false;
                        if(res.code){
                            var dt = res.data,len = dt.length,str = '';
                            for(var i=0;i<len;i++){
                                var v = dt[i];
                                str+='<option value="'+v.id+'">'+v.name+'</option>';
                            };
                            J_qu.html('<option value="0">选择区</option>'+str);
                        }
                    }
                });
            };
        });

        // 保存
        J_hounew_save.click(function(){
            var name = $('#J_name_h').val().trim(),newadr = {}; // 预定义地址数据
            if(!name.length){
                CUES.tip({"msg":"请填写收货人姓名","type":"danger"})
                return false;
            };
            var regphone = /^[1][0-9]{10}$/ig,
                phone = $('#J_phone_h').val().trim();
            if(!regphone.test(phone)){
                CUES.tip({"msg":"手机号不正确","type":"danger"})
                return false;
            };
            if(J_sheng.val()==0){
                CUES.tip({"msg":"请选择省份","type":"danger"})
                return false;
            };
            if(J_shi.val()==0){
                CUES.tip({"msg":"请选择市","type":"danger"})
                return false;
            };
            if(J_qu.val()==0){
                CUES.tip({"msg":"请选择区","type":"danger"})
                return false;
            };
            var street = $('#J_detial').val().trim();
            if(street.length<=5){
                CUES.tip({"msg":"详细地址过短","type":"danger"})
                return false;
            };
            newadr.name = name;
            newadr.phone = phone;
            newadr.sheng = J_sheng.val();
            newadr.shi = J_shi.val();
            newadr.qu = J_qu.val();
            newadr.street = street;

            if(adr_edit){ // 判断是否是编辑数据
                newadr.aid = adr_edit;
            };

            // 可根据传入的 newadr.aid 的值判断是否是编辑数据

            isajax = true;
            // ajax保存地址
            $.ajax({ 
                type: "POST",
                url: "/wap/addresses",
                data: {newadr},
                dataType: "json",
                success: function(res){
                    isajax = false;
                    if(res.code){
                        CUES.tip({"msg":"保存成功","type":"success","callback":function(){
                            // 返回res里需重新组合json对象
                            newadr.aid = 5; // 赋值地址id
                            newadr.address = res.data;//"xx上海市浦东新区浦东软件园郭守敬园1号楼1上海市浦东新区浦东软件园郭守敬园1号楼525室";
                            data.address.type = data.lstype;
                            data.address.info = newadr;
                            setadrdom();
                            close_pop();
                        }});
                    }
                }
            });
        });


        var J_pday_in = $('#J_pday_in'),
            J_ptime_in = $('#J_ptime_in'),
            J_saveadr = $('#J_saveadr'),
            J_can_name = $('#J_can_name');

        var J_pop_all_part = $('#J_pop_all_part');


        $('.J_pop_line').click(function(){
            var self = $(this);
            J_pop_all_part.show();
            setTimeout(function(){
                J_pop_all_part.addClass('pop_active');
                $(self.attr('data-target')).addClass('pop_slide_active');
            },10)
        });

        $('.J_close_pop_part').click(function(){
            J_pop_all_part.removeClass('pop_active').hide();
            J_pop_all_part.find('.pop_slide_active').removeClass('pop_slide_active');
        });

        // 更改配送地址
        $('.J_padr').click(function(){
            var self = $(this),
                aid = self.attr('data-aid'),
                shopname = self.attr('data-shopname'),
                address = self.attr('data-address');
            self.addClass('padr_active').siblings().removeClass('padr_active');
            obj_info.shopname = shopname;
            obj_info.aid = aid;
            obj_info.address = address;
            J_can_name.html(shopname);

        });

        // var shijianduan = [
        //     {"value":1,"name":"09:00-10:10"},
        //     {"value":2,"name":"10:00-11:00"},
        //     {"value":3,"name":"11:00-12:00"},
        //     {"value":4,"name":"12:00-13:00"},
        //     {"value":5,"name":"13:00-14:00"},
        //     {"value":6,"name":"14:00-15:00"},
        //     {"value":7,"name":"15:00-16:00"}
        // ];

        var shijianduan = <%= @timearr.to_json.html_safe %>

        var day = new dataSelect({
            "target":document.getElementById('J_ppart'), // 目标对象dom
            "fieldshow":"name",// 必选 显示字段
            "fieldvalue":"value",// 必选 值匹配字段
            "data":shijianduan, // 选项数据
            "default_v":obj_info.timepart||shijianduan[0].value,
            "change":function(v){
                obj_info.timepart = v.value; // 更新时间段id
                obj_info.timepart_name = v.name;
                J_ptime_in.html(v.name)
            }
        });

        var date = new Date(),datearr = [],xarr=['日','一','二','三','四','五','六']; // 循环后面六十天时间
        for(var i=0;i<60;i++){
            date.setDate(date.getDate()+1);
            var m = date.getMonth()+1,
                d = date.getDate();
            m = m<10?'0'+m:m;
            d = d<10?'0'+d:d;
            datearr.push({"value":date.getFullYear()+"/"+m+"/"+d,"name":m+"-"+d+"(星期"+xarr[date.getDay()]+")"})
        };
        var day = new dataSelect({
            "target":document.getElementById('J_pday'), // 目标对象dom
            "fieldshow":"name",// 必选 显示字段
            "fieldvalue":"value",// 必选 值匹配字段
            "data":datearr, // 选项数据
            "default_v":obj_info.day||datearr[0].value,
            "change":function(v){
                obj_info.day = v.value; // 更新时间段id
                obj_info.day_name = v.name;
                J_pday_in.html(v.name);
            }
        });

        J_saveadr.click(function(){
            if(!obj_info.aid){
                CUES.tip({"msg":"请选择配送门店","type":"danger"})
                return false;
            };
            var name = $('#J_name').val().trim();
            // if(!name.length){
            //     CUES.tip({"msg":"请填写就餐人姓名","type":"danger"})
            //     return false;
            // }else{
                obj_info.name = name;
            // };
            var regphone = /^[1][0-9]{10}$/ig,
                phone = $('#J_phone').val().trim();
            // if(!regphone.test(phone)){
            //     CUES.tip({"msg":"就餐人手机号不正确","type":"danger"})
            //     return false;
            // }else{
                obj_info.phone = phone;
            // };

            console.log(obj_info);

            data.address.info = obj_info;
            data.address.type = data.lstype;
            setadrdom();

            J_pop_slide.removeClass('pop_slide_active');
            J_pop_all.removeClass('pop_active pop_h100').hide();
            J_pop_all_part.find('.pop_slide_active').removeClass('pop_slide_active');
            J_pop_all_part.removeClass('pop_active').hide();
            close_pop();
            J_html.show();
            calc_freight();
        });

        calc_freight();

        function calc_freight() {
            isajax = true;
            // ajax请求运费
            $.ajax({ 
                type: "GET",
                url: "/wap/orders/calc_freight",
                data: {data},
                dataType: "json",
                success: function(res){
                    isajax = false;
                    if(res.code){
                        $('#J_freight').html(parseFloat(res.value).toFixed(2));
                        $('#J_total').html((parseFloat(data.countprice) + parseFloat(res.value)).toFixed(2));
                    }
                }
            });
        }

    });
</script>