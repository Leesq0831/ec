namespace :permission do

  desc 'init permission'
  task :init => :environment do
    puts 'Starting init permissions ******'
    permission_list = {
      'a' => '系统管理',
      '1' => '用户管理',
      '1,2' => '角色管理',
      'b' => '微官网',
      '4' => '基础设置',
      '4,2' => '模板样式',
      '4,3' => '站点内容',
      '4,4' => '首页幻灯片',
      '4,5' => '首页背景图',
      '4,6' => '导航菜单',
      '4,7' => '快捷菜单',
      '4,8' => '个性域名',
      'c' => '微会员卡',
      '13' => '基础设置',
      '13,2' => '会员管理',
      '13,3' => '会员营销',
      '13,4' => '营销报表',
      'd' => '内容管理',
      '18' => '资讯中心',
      '18,2' => '展示中心',
      '18,3' => '素材管理',
      '18,4' => '评论管理',
      'e' => '微活动',
      '23' => '我的营销互动',
      '23,2' => '优惠券',
      '23,3' => '刮刮卡',
      '23,4' => '幸运大转盘',
      '23,5' => '一战到底',
      '23,6' => '砸金蛋',
      '23,7' => '老虎机',
      '23,8' => '微助力',
      '23,9' => '摇一摇抽奖',
      '23,10' => '美图猜猜',
      '23,11' => '吸粉游戏',
      '23,12' => '拆包有奖',
      '23,13' => '推荐有奖',
      '23,14' => '节日礼包',
      '23,15' => '微信卡券',
      '23,16' => '微红包',
      '23,17' => '全民经纪人',
      'f' => '微现场',
      '41' => '微信墙',
      '41,2' => '摇一摇',
      'g' => '微互动',
      '44' => '微报名',
      '44,2' => '微投票',
      '44,3' => '微调研',
      '44,4' => '微相册',
      '44,5' => '微留言',
      '44,6' => '微贺卡',
      '44,7' => '图片分享',
      '44,8' => '微社区',
      '44,9' => '微预定',
      '44,10' => '微场景',
      '44,11' => '360全景',
      'h' => '微硬件',
      '56' => '微打印机',
      '56,2' => '微小票机',
      'i' => '微插件',
      '59' => '生活助手',
      '59,2' => '休闲游戏',
      'j' => '二维码推广',
      '62' => '二维码管理',
      '62,2' => '二维码分类',
      '62,3' => '统计推广',
      'k' => '微门店',
      '66' => '基础设置',
      '66,2' => '门店设置',
      '66,3' => '权限管理',
      'l' => '微团购',
      '70' => '微团购',
      '70,2' => '微团购支付版',
      'm' => '微电商',
      'n' => '微生活',
      'o' => '微商圈',
      'p' => '社区通',
      'q' => '微餐饮',
      '77' => '基本信息',
      '77,2' => '规则设定',
      '77,3' => '菜单管理',
      '77,4' => '订餐订单',
      '77,5' => '订座订单',
      '77,6' => '销售日报表',
      '77,7' => '下单时间分析',
      'r' => '微外卖',
      '85' => '基本信息',
      '85,2' => '规则设定',
      '85,3' => '菜单管理',
      '85,4' => '外卖订单',
      '85,5' => '销售日报表',
      '85,6' => '下单时间分析',
      's' => '微服务',
      't' => '微旅游',
      'u' => '微婚礼',
      'v' => '微医疗',
      'w' => '微教育',
      'x' => '微汽车',
      '97' => '我的4S店',
      '97,2' => '车系管理',
      '97,3' => '车型管理',
      '97,4' => '保养预约',
      '97,5' => '试驾预约',
      '97,6' => '销售代表',
      '97,7' => '车主关怀',
      '97,8' => '实用工具',
      'y' => '微房产',
      '106' => '楼盘简介',
      '106,2' => '户型图设置',
      '106,3' => '微楼书',
      '106,4' => '预约看房查询',
      '106,5' => '销售顾问管理',
      '106,6' => '房友印象管理',
      '106,7' => '实景拍摄管理',
      '106,8' => '专家点评管理',
      'z' => '微小区',
      '115' => '基本信息',
      '115,2' => '小区公告',
      '115,3' => '报修管理',
      '115,4' => '投诉建议',
      '115,5' => '常用电话',
      '115,6' => '业主中心',
      '115,7' => '周边生活',
      'ab' => '微政务',
      '123' => '信访大厅',
      '123,1' => '微信互动',
      'ac' => '微公益'
    }

    Account.find_each do |account|
      role = account.employee_roles.where(account_id: account.id, name: "系统管理员").first_or_create

      permission_list.each do |key, value|
        parentid = key.to_i == 0 ? 0 : key.split(',').first.to_i

        permission = Permission.where(name: value, parent_id: parentid).first_or_create

        RolePermissionMap.where(
          employee_role_id: role.id,
          permission_id: permission.id
        ).first_or_create
      end

      employee = Employee.where(account_id: account.id, name: account.nickname).first
      unless employee
        employee = Employee.new(account_id: account.id, name: account.nickname, password_digest: account.password_digest)
        employee.save(validate: false)
      end

      EmployeeRoleMap.where(
        employee_id: employee.id,
        employee_role_id: role.id
      ).first_or_create
    end
    puts "finished"
  end

end
